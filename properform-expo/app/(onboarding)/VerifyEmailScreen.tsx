import React, { useState, useEffect, useContext } from "react";
import {
  View,
  Text,
  StyleSheet,
  Alert,
  Keyboard,
  TouchableWithoutFeedback,
  ScrollView,
  KeyboardAvoidingView,
  Platform,
  TouchableOpacity,
  TextInput,
} from "react-native";
import { SafeAreaView } from "react-native-safe-area-context";
import Header from "@/src/components/header";
import ProgressDots from "@/src/components/ProgressDots";
import AsyncStorage from "@react-native-async-storage/async-storage";
import { useRouter } from "expo-router";
import { typography } from "@/src/theme/typography";
import { spacing } from "@/src/theme/spacing";
import { colors } from "@/src/theme/colors";
import { MaterialIcons as Icon } from "@expo/vector-icons";
import axios from "axios";
import { OnboardingContext } from "@/src/context/OnboardingContext";

export default function VerifyEmailScreen() {
  const router = useRouter();
  const { finishOnboarding } = useContext(OnboardingContext);

  const [email, setEmail] = useState<string | null>(null);
  const [code, setCode] = useState("");
  const [error, setError] = useState("");

  useEffect(() => {
    async function loadEmail() {
      const storedEmail = await AsyncStorage.getItem("onboarding_email");
      setEmail(storedEmail);
    }
    loadEmail();
  }, []);

  const handleVerify = async () => {
    setError("");

    // doppelter Schutz (sollte nicht eintreten)
    if (code.length !== 6) {
      setError("Der Code muss 6-stellig sein.");
      return;
    }

    try {
      await axios.post(
        "https://api.properform.app/auth/check-verification-code",
        {
          email,
          code,
        },
      );

      await AsyncStorage.setItem("onboardingFinished", "true");
      finishOnboarding();
      router.replace("../(tabs)/HomeScreen");
    } catch (error: any) {
      setError("Bitte gib den richtigen Code ein.");
      Alert.alert("Verifikation fehlgeschlagen");
    }
  };

  const handleBack = () => {
    router.back();
  };

  return (
    <SafeAreaView style={styles.container} edges={["top"]}>
      <Header />

      <KeyboardAvoidingView
        style={{ flex: 1 }}
        behavior={Platform.OS === "ios" ? "padding" : undefined}
      >
        <TouchableWithoutFeedback onPress={Keyboard.dismiss}>
          <ScrollView
            contentContainerStyle={styles.scrollContent}
            keyboardShouldPersistTaps="handled"
          >
            <View style={styles.header}>
              <Text style={typography.title}>E-Mail best√§tigen</Text>
              <Text style={[typography.body, styles.subheader]}>
                Gib den 6-stelligen Code ein
              </Text>
            </View>

            <View style={styles.card}>
              <Text style={styles.label}>Verifikationscode</Text>

              <TextInput
                style={[styles.input, error ? { borderColor: "red" } : null]}
                value={code}
                onChangeText={(text) => {
                  const numbersOnly = text.replace(/[^0-9]/g, "");
                  if (numbersOnly.length <= 6) {
                    setCode(numbersOnly);
                  }
                }}
                keyboardType="number-pad"
                maxLength={6}
                placeholder="123456"
                placeholderTextColor="#aaa"
              />

              {error ? <Text style={styles.errorText}>{error}</Text> : null}
            </View>

            <Text style={styles.hintText}>
              E-Mail nicht gefunden? Sieh auch im Spam-Ordner nach.
            </Text>

            <View style={styles.navigation}>
              <TouchableOpacity style={styles.arrowButton} onPress={handleBack}>
                <Icon name="arrow-back" size={24} color={colors.white} />
              </TouchableOpacity>

              <ProgressDots total={5} current={5} />

              <TouchableOpacity
                style={[
                  styles.arrowButton,
                  code.length !== 6 && { opacity: 0.4 },
                ]}
                onPress={handleVerify}
                disabled={code.length !== 6}
              >
                <Icon name="arrow-forward" size={24} color={colors.white} />
              </TouchableOpacity>
            </View>
          </ScrollView>
        </TouchableWithoutFeedback>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
    paddingHorizontal: spacing.screenPaddingHorizontal,
  },
  scrollContent: {
    flexGrow: 1,
    paddingTop: spacing.md,
  },
  header: {
    marginBottom: spacing.lg,
  },
  subheader: {
    fontSize: 18,
    marginTop: spacing.md,
  },
  card: {
    backgroundColor: colors.white,
    borderRadius: 16,
    padding: spacing.md,
    shadowColor: colors.black,
    shadowOpacity: 0.04,
    shadowRadius: 10,
    shadowOffset: { width: 0, height: 4 },
    elevation: 2,
  },
  label: {
    ...typography.label,
    color: colors.black,
    marginBottom: 8,
    marginLeft: 4,
  },
  input: {
    height: 56,
    borderWidth: 2,
    borderColor: "#E5E7EB",
    borderRadius: 12,
    paddingHorizontal: 16,
    fontSize: 18,
    backgroundColor: "#fff",
  },
  errorText: {
    ...typography.error,
    marginTop: 6,
    marginLeft: 4,
  },
  navigation: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    paddingBottom: spacing.lg,
    marginTop: "auto",
    paddingTop: spacing.lg,
  },
  arrowButton: {
    width: 56,
    height: 56,
    borderRadius: 28,
    backgroundColor: colors.primaryBlue,
    alignItems: "center",
    justifyContent: "center",
  },
  hintText: {
    fontSize: 14,
    color: colors.textSecondary,
    marginTop: 6,
    textAlign: "center",
  },
});
